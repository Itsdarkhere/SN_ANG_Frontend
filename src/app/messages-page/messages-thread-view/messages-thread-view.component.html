<div class="d-flex flex-column h-100">
  <!-- Top Bar -->
  <div
    *ngIf="!isMobile"
    class="w-100 border-bottom border-color-grey messages-top-bar-height d-flex align-items-center pl-15px fs-15px font-weight-bold top-bar-messages-thread"
    style="min-height: 80px"
  >
    <!-- Avatar -->
    <!-- This should only link if the user has a profile (i.e. if it's just a pubkey, no link) -->
    <a
      *ngIf="messageThread"
      class="messages-thread__avatar mr-15px"
      [ngClass]="{ 'cursor-auto': !counterpartyUsername() }"
      [routerLink]="counterpartyUsername() ? AppRoutingModule.profilePath(counterpartyUsername()) : []"
      queryParamsHandling="merge"
      [avatar]="messageThread.PublicKeyBase58Check"
    ></a>

    <div *ngIf="messageThread">
      <!-- Show username if avaialble-->
      <div *ngIf="counterpartyUsername(); else elseBlock">
        <a
          class="link--unstyled"
          [routerLink]="AppRoutingModule.profilePath(counterpartyUsername())"
          queryParamsHandling="merge"
        >
          <span>{{ counterpartyUsername() }}</span>
          <span *ngIf="messageThread.ProfileEntryResponse.IsVerified" class="ml-1 text-primary">
            <i class="fas fa-check-circle fa-md align-middle"></i>
          </span>
        </a>
      </div>
      <!-- Otherwise show public key-->
      <ng-template #elseBlock>
        {{ messageThread.PublicKeyBase58Check }}
      </ng-template>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="w-100 background-messages-light m-0px p-0px" style="overflow: hidden">
    <div
      *ngIf="messageThread"
      class="vh-80 w-100 p-15px disable-scrollbars"
      style="overflow-y: scroll"
      id="messagesContainer"
      #messagesContainer
    >
      <message
        *ngFor="let message of messageThread.Messages; let ii = index"
        [nextMessage]="ii < messageThread.Messages.length - 1 ? messageThread.Messages[ii + 1] : null"
        [message]="message"
        [profile]="messageThread.ProfileEntryResponse"
      ></message>
      <div class="d-lg-none d-block global__bottom-bar-mobile-height mb-5px"></div>
      <div class="d-lg-block d-none global__top-bar__height"></div>
      <div class="global__bottom-bar-mobile-height"></div>
    </div>
  </div>

  <!-- Create Message Input -->
  <div class="messages-thread-send-messages background-messages-light">
    <div class="fake-textarea-container">
      <a
        class="messages-thread__avatar_send_message mr-5px ml-10px"
        [avatar]="this.globalVars.loggedInUser.PublicKeyBase58Check"
      ></a>
      <textarea
        (keypress)="_messageTextChanged($event)"
        [(ngModel)]="messageText"
        placeholder="Write something here..."
        class="py-5px fs-15px messages-thread__border-radius flex-grow-1 form-control messages-textarea"
        style="height: 50px"
      ></textarea>
      <button
        *ngIf="!sendMessageBeingCalled"
        (click)="_sendMessage()"
        class="btn btn-send-message fs-15px ml-15px messages-thread__border-radius"
      >
        <img src="/assets/icons/send-message.svg" />
      </button>
      <button
        *ngIf="sendMessageBeingCalled"
        class="btn btn-send-message fs-15px ml-15px messages-thread__border-radius"
      >
        <i class="fa fa-spinner fa-spin"></i>
      </button>
    </div>
  </div>
</div>
